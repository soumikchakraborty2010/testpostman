<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>XML Editor</title>

    <style>
        body {
            font-family: 'Arial', sans-serif;
            margin: 20px;
            font-size: 16px;
            color: #333;
        }

        h2 {
            font-size: 20px;
        }

        table {
            border-collapse: collapse;
            width: 100%;
            margin-top: 20px;
            margin-bottom: 20px;
        }

        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }

        th {
            background-color: #f2f2f2;
        }

        th:first-child {
            width: 50px;
        }

        form {
            margin-top: 20px;
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 5px;
        }

        input[type="text"],
        select {
            width: 100%;
            padding: 8px;
            margin-bottom: 10px;
            box-sizing: border-box;
        }

        input[type="button"] {
            background-color: #4CAF50;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 10px;
            width: 10%;
        }

        #readOnlyTable {
            margin-top: 20px;
        }

        #addButton {
            background-color: #008CBA;
            margin-top: 10px;
        }

        #removeButton {
            background-color: #FF6347;
            margin-top: 10px;
            margin-right: 5px;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.4);
        }

        .modal-content {
            background-color: #fefefe;
            margin: 15% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }

        .close:hover,
        .close:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }

        .tab-button {
            background-color: #f2f2f2;
            border: 1px solid #ccc;
            padding: 10px;
            cursor: pointer;
            float: left;
        }

        .tab-button:hover {
            background-color: #ddd;
        }

        .tab-content-container {
            clear: both; /* Ensure content is below the tabs */
            margin-top: 20px; /* Adjust margin as needed */
            padding-top: 10px; /* Add padding for a little space */
        }

        .tab-content {
            display: none;
        }

        .active-tab {
            display: block;
        }

        .button-container {
        display: flex;
        gap: 7px; 
        }

        button {
            width: 8%; 
            height: 29px;
        }

        .tag {
            font-weight: bold;
            font-size: 18px; 
            cursor: pointer;
        }

        .active-tag {
            font-weight: bold;
            font-size: 18px; 
        }

        #xmlTableContainer {
            max-height: 400px; /* Set the desired fixed height */
            overflow-y: auto; /* Add a vertical scrollbar if needed */
        }

        /* Additional styles for the table header */
        #xmlTableContainer table thead {
            position: sticky;
            top: 0;
            background-color: #f2f2f2;
        }
    </style>
</head>
<body onload="loadXMLonLoad()">
    <div>
        <!-- Tab navigation -->
        <!-- <div class="tab-button" onclick="showTab('viewTestCases')">View Test Cases</div>
        <div class="tab-button" onclick="showTab('updateTags')">Update Tags</div> -->
        <div class="tab-button" data-tab="viewTestCases" onclick="showTab('viewTestCases')">View Test Cases</div>
        <div class="tab-button" data-tab="updateTags" onclick="showTab('updateTags')">Update Tags</div>


        <!-- Content container for tabs -->
        <div class="tab-content-container">

            <div id="viewTestCasesTab" class="tab-content active-tab">
                <!-- Content for the View Test Cases tab -->
                <h2>View Test Cases</h2>

                <!-- Buttons to collapse and expand all -->
                <div class="button-container">
                    <button onclick="collapseAll()">Collapse All</button>
                    <button onclick="expandAll()">Expand All</button>
                    <button onclick="refreshPage()">Refresh</button>
                </div>

                <br>
                <!-- Content for the View Test Cases tab -->
                <div id="tagsContainer"></div>
            
                <script>
                    function showTestCases(tag) {
                        var testCases = document.getElementById(tag + "-testCases");
                        var icon = document.getElementById(tag + "-icon");
            
                        if (testCases.style.display === "none") {
                            testCases.style.display = "block";
                            icon.innerHTML = "[-]";
                            document.getElementById(tag).classList.add('active-tag');
                        } else {
                            testCases.style.display = "none";
                            icon.innerHTML = "[+]";
                            document.getElementById(tag).classList.remove('active-tag');
                        }
                    }

                    function refreshViewTestCases() {
                        var xhr = new XMLHttpRequest();
                        xhr.onreadystatechange = function () {
                            if (xhr.readyState == 4 && xhr.status == 200) {
                                var parser = new DOMParser();
                                var xmlDoc = parser.parseFromString(xhr.responseText, "text/xml");

                                // Clear existing content
                                var tagsContainer = document.getElementById("tagsContainer");
                                tagsContainer.innerHTML = '';

                                // Regenerate tree view
                                generateTreeView(xmlDoc);
                            }
                        };

                        xhr.open("GET", "poc.xml", true);
                        xhr.send();
                    }
            
                    // Function to expand all
                    function expandAll() {
                        var testCasesContainers = document.querySelectorAll('[id$="-testCases"]');
                        testCasesContainers.forEach(testCases => {
                            testCases.style.display = "block";
                        });

                        var icons = document.querySelectorAll('[id$="-icon"]');
                        icons.forEach(icon => {
                            icon.innerHTML = "[-]";
                        });
                    }

                    // Function to collapse all
                    function collapseAll() {
                        var testCasesContainers = document.querySelectorAll('[id$="-testCases"]');
                        testCasesContainers.forEach(testCases => {
                            testCases.style.display = "none";
                        });

                        var icons = document.querySelectorAll('[id$="-icon"]');
                        icons.forEach(icon => {
                            icon.innerHTML = "[+]";
                        });
                    }

                    function refreshPage() {
                        location.reload();
                    }
            
                    // Function to load XML file
                    function loadXML(timestamp) {
                        var xhr = new XMLHttpRequest();
                        var url = "poc.xml?timestamp=" + timestamp;
                        console.log("XML request URL:", url); // Log the URL for debugging
                        xhr.onreadystatechange = function () {
                            if (xhr.readyState == 4 && xhr.status == 200) {
                                var parser = new DOMParser();
                                var xmlDoc = parser.parseFromString(xhr.responseText, "text/xml");

                                generateTreeView(xmlDoc);
                            }
                        };

                        // Append timestamp to URL to avoid caching
                        xhr.open("GET", url, true);
                        xhr.send();
                    }

                    // Function to reload XML during page load
                    function loadXMLonLoad() {
                        // Use the current timestamp to avoid caching
                        loadXML(new Date().getTime());
                    }

                    // Function to refresh view test cases
                    function refreshViewTestCases() {
                        // Use the current timestamp to avoid caching
                        loadXML(new Date().getTime());
                    }
            
                    // Function to generate tree view
                    // function generateTreeView(xmlDoc) {
                    //     var tags = Array.from(xmlDoc.querySelectorAll("testCase")).reduce((acc, testCase) => {
                    //         var testCaseTags = testCase.getAttribute("tags").split(",");
                    //         return acc.concat(testCaseTags);
                    //     }, []);
            
                    //     tags = Array.from(new Set(tags));
            
                    //     var tagsContainer = document.getElementById("tagsContainer");
            
                    //     tags.forEach(tag => {
                    //         var tagElement = document.createElement("div");
                    //         tagElement.className = "tag"; // Add the .tag class
                    //         tagElement.innerHTML = `<span id="${tag}-icon" onclick="showTestCases('${tag}')">[+]</span> ${tag}`;
                    //         tagsContainer.appendChild(tagElement);
            
                    //         var testCasesContainer = document.createElement("div");
                    //         testCasesContainer.id = `${tag}-testCases`;
                    //         testCasesContainer.style.marginLeft = "20px";
                    //         testCasesContainer.style.display = "none";
            
                    //         var filteredTestCases = xmlDoc.querySelectorAll(`testCase[tags*="${tag}"]`);
            
                    //         filteredTestCases.forEach(testCase => {
                    //             var testCaseElement = document.createElement("div");
                    //             testCaseElement.innerHTML = `${testCase.getAttribute("id")} : ${testCase.getAttribute("name")}`;
                    //             testCasesContainer.appendChild(testCaseElement);
                    //         });
            
                    //         tagsContainer.appendChild(testCasesContainer);
                    //     });
                    // }

                    function generateTreeView(xmlDoc) {
                        var tagsContainer = document.getElementById("tagsContainer");
                        tagsContainer.innerHTML = ''; // Clear existing content

                        var allTestCases = xmlDoc.querySelectorAll("testCase");

                        // Separate test cases into those with tags and those without
                        var testCasesWithTags = Array.from(allTestCases).filter(testCase => {
                            var tags = testCase.getAttribute("tags");
                            return tags && tags.trim() !== "";
                        });

                        var testCasesWithoutTags = Array.from(allTestCases).filter(testCase => {
                            var tags = testCase.getAttribute("tags");
                            return !tags || tags.trim() === "";
                        });

                        // Create a section for test cases with no tags
                        var noTagsSection = document.createElement("div");
                        noTagsSection.className = "tag";
                        noTagsSection.innerHTML = `<span id="noTags-icon" onclick="showTestCases('noTags')">[+]</span> No Tags`;
                        tagsContainer.appendChild(noTagsSection);

                        var noTagsTestCasesContainer = document.createElement("div");
                        noTagsTestCasesContainer.id = "noTags-testCases";
                        noTagsTestCasesContainer.style.marginLeft = "20px";
                        noTagsTestCasesContainer.style.display = "none";

                        testCasesWithoutTags.forEach(testCase => {
                            var testCaseElement = document.createElement("div");
                            testCaseElement.innerHTML = `${testCase.getAttribute("id")} : ${testCase.getAttribute("name")}`;
                            noTagsTestCasesContainer.appendChild(testCaseElement);
                        });

                        tagsContainer.appendChild(noTagsTestCasesContainer);

                        // Create sections for test cases with tags
                        var tags = Array.from(new Set(testCasesWithTags.reduce((acc, testCase) => {
                            var testCaseTags = testCase.getAttribute("tags").split(",");
                            return acc.concat(testCaseTags);
                        }, [])));

                        tags.forEach(tag => {
                            var tagElement = document.createElement("div");
                            tagElement.className = "tag";
                            tagElement.innerHTML = `<span id="${tag}-icon" onclick="showTestCases('${tag}')">[+]</span> ${tag}`;
                            tagsContainer.appendChild(tagElement);

                            var testCasesContainer = document.createElement("div");
                            testCasesContainer.id = `${tag}-testCases`;
                            testCasesContainer.style.marginLeft = "20px";
                            testCasesContainer.style.display = "none";

                            var filteredTestCases = testCasesWithTags.filter(testCase => testCase.getAttribute("tags").includes(tag));

                            filteredTestCases.forEach(testCase => {
                                var testCaseElement = document.createElement("div");
                                testCaseElement.innerHTML = `${testCase.getAttribute("id")} : ${testCase.getAttribute("name")}`;
                                testCasesContainer.appendChild(testCaseElement);
                            });

                            tagsContainer.appendChild(testCasesContainer);
                        });
                    }


            
                    // Load XML on page load
                    //loadXML();
                </script>           

            </div>

            <div id="updateTagsTab" class="tab-content">
                <h2>Fleet Robot Test Case Tag Addition/Modification</h2>
                <form id="xmlForm">
                    <label>
                        <input type="radio" name="editType" value="existing" onclick="toggleEditMode(this)" onchange="handleRadioButtonChange()">
                        Select Existing Test Cases
                    </label>
                    <label>
                        <input type="radio" name="editType" value="new" onclick="toggleEditMode(this)" onchange="handleRadioButtonChange()">
                        Add New
                    </label>
                    <div id="xmlTableContainer">
                        <table id="xmlTable">
                            <thead>
                                <tr>
                                    <th>Select</th>
                                    <th>TC ID</th>
                                    <th>TC Name</th>
                                    <th>Tags</th>
                                </tr>
                            </thead>
                            <tbody id="xmlTableBody">
                                <!-- Existing data will be displayed here -->
                            </tbody>
                        </table>
                    </div>
                    <br>
                    <label for="tcId">TC ID:</label>
                    <input type="text" id="tcId" readonly>

                    <label for="tcName">TC Name:</label>
                    <input type="text" id="tcName" readonly>

                    <label for="tags">Tags:</label>
                    <select id="tags" multiple>
                        <!-- Options will be dynamically populated based on selected row -->
                    </select>

                    <input type="button" value="Add" onclick="addRowToReadOnlyTable()" id="addButton">

                    <div id="readOnlyTable">
                        <h3>Click Update/Submit button below to update these Test Cases</h3>
                        <table id="readOnlyTableBody">
                            <thead>
                                <tr>
                                    <th></th>
                                    <th>TC ID</th>
                                    <th>TC Name</th>
                                    <th>Tags</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Data will be dynamically populated here -->
                            </tbody>
                        </table>
                        <input type="button" value="Remove" onclick="removeSelectedRows()" id="removeButton">
                        <input type="button" value="Update" onclick="updateXml()" id="submitButton" disabled>
                    </div>

                    <div id="messageModal" class="modal">
                        <div class="modal-content">
                            <span class="close" onclick="closeMessageModal()">&times;</span>
                            <p id="messageText"></p>
                        </div>
                    </div>
                </form>
            </div>
    </div>

    <script>
        function showTab(tabName) {
            var tabs = document.querySelectorAll('.tab-content');
            tabs.forEach(function(tab) {
                tab.classList.remove('active-tab');
            });

            var tabButtons = document.querySelectorAll('.tab-button');
            tabButtons.forEach(function(button) {
                button.style.backgroundColor = ''; // Reset background color for all tab buttons
            });

            document.getElementById(tabName + 'Tab').classList.add('active-tab');
            document.querySelector('.tab-button[data-tab="' + tabName + '"]').style.backgroundColor = '#8FED8F'; 
        }

        function toggleEditMode(radio) {
            var table = document.getElementById("xmlTable");
            var tcIdInput = document.getElementById("tcId");
            var tcNameInput = document.getElementById("tcName");
            var tagsSelect = document.getElementById("tags");
            var submitButton = document.getElementById("submitButton");

            if (radio.value === "existing") {
                table.removeAttribute("disabled");
                tcIdInput.setAttribute("readonly", true);
                tcNameInput.setAttribute("readonly", true);
                tagsSelect.removeAttribute("disabled");
                submitButton.removeAttribute("disabled");
                tcIdInput.value = "";
                tcNameInput.value = "";
                submitButton.value = "Update";
            } else if (radio.value === "new") {
                table.setAttribute("disabled", true);
                tcIdInput.value = "";
                tcNameInput.value = "";
                tagsSelect.innerHTML = "";
                tagsSelect.setAttribute("disabled", true);
                submitButton.setAttribute("disabled", true);
                tcIdInput.removeAttribute("readonly");
                tcNameInput.removeAttribute("readonly");
                submitButton.value = "Update";
            }
        }

        function populateTable(xmlDoc) {
            var tableBody = document.getElementById("xmlTableBody");
            tableBody.innerHTML = "";

            var selectExisting = document.querySelector('input[name="editType"][value="existing"]').checked;

            if (selectExisting) {
                var testCaseNodes = xmlDoc.querySelectorAll('testCase');
                testCaseNodes.forEach(function (testCase) {
                    var row = tableBody.insertRow();
                    var cellSelect = row.insertCell(0);
                    var cellId = row.insertCell(1);
                    var cellName = row.insertCell(2);
                    var cellTags = row.insertCell(3);
                    var radio = document.createElement('input');
                    radio.type = 'radio';
                    radio.name = 'selectedRow';
                    radio.onclick = function () {
                        handleRadioClick(testCase);
                    };
                    cellSelect.appendChild(radio);
                    cellId.innerText = testCase.getAttribute('id');
                    cellName.innerText = testCase.getAttribute('name');
                    cellTags.innerText = testCase.getAttribute('tags');
                });

                document.getElementById("xmlTable").style.display = "table";
            } else {
                document.getElementById("xmlTable").style.display = "none";
            }
        }

        function handleRadioClick(testCase) {
            var tcIdInput = document.getElementById("tcId");
            var tcNameInput = document.getElementById("tcName");
            var tagsSelect = document.getElementById("tags");

            tcIdInput.value = testCase.getAttribute('id');
            tcNameInput.value = testCase.getAttribute('name');

            tagsSelect.innerHTML = "";

            var tags = testCase.getAttribute('tags').split(',');

            tags.forEach(function (tag) {
                var option = document.createElement('option');
                option.value = tag.trim();
                option.text = tag.trim();
                tagsSelect.add(option);
            });

            tagsSelect.removeAttribute("disabled");

            checkSubmitButtonState();
        }

        function updateXml() {
            // Your existing code for updating XML
        }

        function checkSubmitButtonState() {
            var tcIdInput = document.getElementById("tcId");
            var tcNameInput = document.getElementById("tcName");
            var tagsSelect = document.getElementById("tags");
            var submitButton = document.getElementById("submitButton");

            if (tcIdInput.value && tcNameInput.value && tagsSelect.selectedOptions.length > 0) {
                submitButton.removeAttribute("disabled");
            } else {
                submitButton.setAttribute("disabled", true);
            }
        }

        var initialXhr = new XMLHttpRequest();
        initialXhr.onreadystatechange = function () {
            if (initialXhr.readyState == 4 && initialXhr.status == 200) {
                var initialXmlDoc = initialXhr.responseXML;
                populateTable(initialXmlDoc);
            }
        };

        initialXhr.open("GET", "poc.xml", true);
        initialXhr.send();

        function handleRadioButtonChange() {
            var editTypeRadios = document.getElementsByName("editType");
            var selectedEditType;

            for (var i = 0; i < editTypeRadios.length; i++) {
                if (editTypeRadios[i].checked) {
                    selectedEditType = editTypeRadios[i].value;
                    break;
                }
            }

            if (selectedEditType === "existing") {
                var xhr = new XMLHttpRequest();
                xhr.onreadystatechange = function () {
                    if (xhr.readyState == 4 && xhr.status == 200) {
                        var xmlDoc = xhr.responseXML;
                        populateTable(xmlDoc);
                    }
                };

                xhr.open("GET", "poc.xml?timestamp=" + new Date().getTime(), true);
                xhr.send();
            } else {
                document.getElementById("xmlTable").style.display = "none";
            }
        }

        function addRowToReadOnlyTable() {
            var tcId = document.getElementById("tcId").value;
            var tcName = document.getElementById("tcName").value;
            var selectedTags = Array.from(document.getElementById("tags").selectedOptions).map(option => option.value);

            var readOnlyTableBody = document.getElementById("readOnlyTableBody").getElementsByTagName('tbody')[0];

            if (selectedTags.length === 0) {
                showMessage("Please select at least one tag.");
                return;
            }

            var existingTcIds = Array.from(readOnlyTableBody.getElementsByTagName('tr')).map(row => row.cells[1].innerText);
            if (existingTcIds.includes(tcId)) {
                showMessage("TC ID already exists in the table. Select and Remove the entry before adding this.");
                return;
            }

            var newRow = readOnlyTableBody.insertRow();
            var cellCheckbox = newRow.insertCell(0);
            var cellId = newRow.insertCell(1);
            var cellName = newRow.insertCell(2);
            var cellTags = newRow.insertCell(3);

            var checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            cellCheckbox.appendChild(checkbox);

            cellId.innerText = tcId;
            cellName.innerText = tcName;
            cellTags.innerText = selectedTags.join(', ');

            closeMessageModal();
        }

        function showMessage(message) {
            var messageText = document.getElementById("messageText");
            messageText.innerText = message;

            var messageModal = document.getElementById("messageModal");
            messageModal.style.display = "block";
        }

        function closeMessageModal() {
            var messageModal = document.getElementById("messageModal");
            messageModal.style.display = "none";
        }

        function removeSelectedRows() {
            var readOnlyTableBody = document.getElementById("readOnlyTableBody").getElementsByTagName('tbody')[0];
            var selectedCheckboxes = readOnlyTableBody.querySelectorAll('input[type="checkbox"]:checked');

            selectedCheckboxes.forEach(function (checkbox) {
                var row = checkbox.closest('tr');
                row.remove();
            });
        }
    </script>

</body>
</html>
